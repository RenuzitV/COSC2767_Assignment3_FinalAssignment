---
- name: Setup CloudWatch Monitoring for EKS and ELB
  hosts: aws_ec2
  become: yes
  vars:
    aws_region: us-east-1
    eks_cluster_name: devops-eks-cluster
    elb_name: a894facca31e7414a98522d544a27fbb

  tasks:
    - name: Download and Install CloudWatch Agent
      get_url:
        url: https://s3.amazonaws.com/amazoncloudwatch-agent/linux/amd64/latest/AmazonCloudWatchAgent.zip
        dest: /tmp/AmazonCloudWatchAgent.zip
      unarchive:
        src: /tmp/AmazonCloudWatchAgent.zip
        dest: /tmp/
        remote_src: yes
      command: /tmp/install.sh
      args:
        chdir: /tmp/

    - name: Configure CloudWatch Agent for EKS and ELB Monitoring
      copy:
        content: |
          {
            "agent": {
              "metrics_collection_interval": 60,
              "run_as_user": "cwagent"
            },
            "metrics": {
              "namespace": "EKS/ELB",
              "metrics_collected": {
                "kubernetes": {
                  "cluster_name": "devops-eks-cluster",
                  "metrics_collection_interval": 60
                },
                "load_balancing": {
                  "elb_name": "a894facca31e7414a98522d544a27fbb",
                  "collection_interval": 60
                }
              }
            },
            "logs": {
              "logs_collected": {
                "files": {
                  "collect_list": [
                    {
                      "file_path": "/var/log/dmesg",
                      "log_group_name": "dmesg",
                      "log_stream_name": "{instance_id}"
                    },
                    {
                      "file_path": "/var/log/messages",
                      "log_group_name": "system-messages",
                      "log_stream_name": "{instance_id}"
                    }
                    // Additional log files can be added here
                  ]
                }
              }
            }
          }
        dest: /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json

    - name: Start CloudWatch Agent
      systemd:
        name: amazon-cloudwatch-agent
        state: started
        enabled: yes
